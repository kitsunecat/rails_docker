"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AwsCdkEcsOnFargateStack = void 0;
const cdk = require("@aws-cdk/core");
const ec2 = require("@aws-cdk/aws-ec2");
const ecs = require("@aws-cdk/aws-ecs");
const ecs_patterns = require("@aws-cdk/aws-ecs-patterns");
const iam = require("@aws-cdk/aws-iam");
const ecr = require("@aws-cdk/aws-ecr");
const s3 = require("@aws-cdk/aws-s3");
const rds = require("@aws-cdk/aws-rds");
const logs = require("@aws-cdk/aws-logs");
const uuid_1 = require("uuid");
const dotenv = require("dotenv");
const core_1 = require("@aws-cdk/core");
dotenv.config();
class AwsCdkEcsOnFargateStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        // app name
        const resoucePrefix = "projectname";
        // ECR(Rails)
        const railsImageRepo = new ecr.Repository(this, "railsImageRepo", {
            repositoryName: `${resoucePrefix}-rails`,
            imageScanOnPush: true,
            imageTagMutability: ecr.TagMutability.MUTABLE
        });
        cdk.Tags.of(railsImageRepo).add("Name", `${resoucePrefix}-rails-image-repo`);
        // ECR(Nginx)
        const nginxImageRepo = new ecr.Repository(this, "nginxImageRepo", {
            repositoryName: `${resoucePrefix}-nginx`,
            imageScanOnPush: true,
            imageTagMutability: ecr.TagMutability.MUTABLE
        });
        cdk.Tags.of(nginxImageRepo).add("Name", `${resoucePrefix}-nginx-image-repo`);
        // VPC, Subnets, GW, RouteTable
        const vpc = new ec2.Vpc(this, "vpc", {
            cidr: "10.0.0.0/16",
            enableDnsHostnames: true,
            enableDnsSupport: true,
            subnetConfiguration: [
                {
                    cidrMask: 24,
                    name: "public",
                    subnetType: ec2.SubnetType.PUBLIC
                }
            ]
        });
        cdk.Tags.of(vpc).add("Name", `${resoucePrefix}-vpc`);
        // security group for alb
        const albSg = new ec2.SecurityGroup(this, "albSg", {
            vpc,
            allowAllOutbound: true
        });
        albSg.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(80));
        albSg.addEgressRule(ec2.Peer.anyIpv4(), ec2.Port.allTraffic());
        cdk.Tags.of(albSg).add("Name", `${resoucePrefix}-alb-Sg`);
        // security group for db
        const dbSg = new ec2.SecurityGroup(this, "dbSg", {
            vpc,
            allowAllOutbound: true
        });
        dbSg.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(5432));
        dbSg.addEgressRule(ec2.Peer.anyIpv4(), ec2.Port.allTraffic());
        cdk.Tags.of(dbSg).add("Name", `${resoucePrefix}-db-Sg`);
        // rds
        const db = new rds.DatabaseInstance(this, "db", {
            vpc,
            vpcSubnets: {
                subnets: vpc.publicSubnets
            },
            engine: rds.DatabaseInstanceEngine.postgres({ version: rds.PostgresEngineVersion.VER_14_1 }),
            instanceIdentifier: `${resoucePrefix}-db`,
            instanceType: ec2.InstanceType.of(ec2.InstanceClass.T3, ec2.InstanceSize.MICRO),
            allocatedStorage: 20,
            storageType: rds.StorageType.GP2,
            databaseName: process.env.DATABASE_NAME || "",
            credentials: {
                username: process.env.DATABASE_USERNAME || "",
                password: cdk.SecretValue.plainText(process.env.DATABASE_PASSWORD || "")
            },
            port: 5432,
            multiAz: true,
            securityGroups: [dbSg]
        });
        cdk.Tags.of(db).add("Name", `${resoucePrefix}-db`);
        // iam
        const ecsTaskExecutionRole = new iam.Role(this, "ecsTaskExecutionRole", {
            roleName: "ecs-task-execution-role",
            assumedBy: new iam.ServicePrincipal("ecs-tasks.amazonaws.com"),
            managedPolicies: [
                iam.ManagedPolicy.fromAwsManagedPolicyName("service-role/AmazonECSTaskExecutionRolePolicy"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonSSMReadOnlyAccess")
            ]
        });
        cdk.Tags.of(ecsTaskExecutionRole).add("Name", `${resoucePrefix}-ecs-task-execution-role`);
        // cluster
        const cluster = new ecs.Cluster(this, "cluster", {
            vpc,
            clusterName: `${resoucePrefix}-cluster`
        });
        cdk.Tags.of(cluster).add("Name", `${resoucePrefix}-cluster`);
        // log group
        const logGroup = new logs.LogGroup(this, "logGroup", {
            logGroupName: "/aws/cdk/ecs/projectname"
        });
        cdk.Tags.of(logGroup).add("Name", `${resoucePrefix}-log-group`);
        // task definition
        const taskDefinition = new ecs.FargateTaskDefinition(this, "taskDefinition", {
            family: `${resoucePrefix}-app-nginx`,
            cpu: 512,
            memoryLimitMiB: 1024,
            executionRole: ecsTaskExecutionRole,
            taskRole: ecsTaskExecutionRole
        });
        cdk.Tags.of(taskDefinition).add("Name", `${resoucePrefix}-task-definition`);
        // rails container
        const railsContainer = new ecs.ContainerDefinition(this, "railsContainer", {
            containerName: "rails",
            taskDefinition,
            image: ecs.ContainerImage.fromEcrRepository(ecr.Repository.fromRepositoryName(this, "railsImage", `${resoucePrefix}-rails`)),
            logging: ecs.LogDriver.awsLogs({
                streamPrefix: "production",
                logGroup
            }),
            environment: {
                DATABASE_HOST: db.dbInstanceEndpointAddress,
                DATABASE_NAME: process.env.DATABASE_NAME || "",
                DATABASE_PASSWORD: process.env.DATABASE_PASSWORD || "",
                DATABASE_USERNAME: process.env.DATABASE_USERNAME || "",
                RAILS_ENV: "production",
                RAILS_MASTER_KEY: process.env.RAILS_MASTER_KEY || "",
                TZ: "Japan"
            },
            command: [
                "bash",
                "-c",
                " \
          bundle install && \
          bundle exec ridgepole --config ./config/database.yml --file ./db/schemafile.rb -E production --apply && \
          rm -f tmp/pids/server.pid && \
          bundle exec rails assets:precompile && \
          bundle exec rails server -e production \
        "
            ],
            workingDirectory: "/app_root",
            essential: true
        });
        // nginx container
        const nginxContainer = new ecs.ContainerDefinition(this, "nginxContainer", {
            containerName: "nginx",
            taskDefinition,
            image: ecs.ContainerImage.fromEcrRepository(ecr.Repository.fromRepositoryName(this, "nginxImage", `${resoucePrefix}-nginx`)),
            logging: ecs.LogDriver.awsLogs({
                streamPrefix: "production",
                logGroup
            }),
            portMappings: [
                {
                    protocol: ecs.Protocol.TCP,
                    containerPort: 80
                }
            ],
            workingDirectory: "/app_root",
            essential: true
        });
        // share volume
        nginxContainer.addVolumesFrom({
            sourceContainer: "rails",
            readOnly: false
        });
        // specify default container
        taskDefinition.defaultContainer = nginxContainer;
        // S3 for logs
        const albLogsBucket = new s3.Bucket(this, `alb-logs-bucket-${uuid_1.v4()}`);
        cdk.Tags.of(albLogsBucket).add("Name", `${resoucePrefix}-alb-logs-bucket`);
        // lb, target group, service
        let service = new ecs_patterns.ApplicationLoadBalancedFargateService(this, "service", {
            serviceName: `${resoucePrefix}-service`,
            cluster,
            taskDefinition,
            desiredCount: 1,
            minHealthyPercent: 100,
            maxHealthyPercent: 200,
            assignPublicIp: true,
            healthCheckGracePeriod: cdk.Duration.seconds(300),
            publicLoadBalancer: true,
            securityGroups: [albSg, dbSg]
        });
        cdk.Tags.of(service).add("Name", `${resoucePrefix}-service`);
        service.targetGroup.healthCheck = {
            path: "/",
            healthyHttpCodes: "200",
            unhealthyThresholdCount: 5,
            timeout: core_1.Duration.seconds(15),
            interval: core_1.Duration.seconds(120),
        };
        service.loadBalancer.logAccessLogs(albLogsBucket);
    }
}
exports.AwsCdkEcsOnFargateStack = AwsCdkEcsOnFargateStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5mcmEtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmZyYS1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBb0M7QUFDcEMsd0NBQXVDO0FBQ3ZDLHdDQUF1QztBQUN2QywwREFBeUQ7QUFDekQsd0NBQXVDO0FBQ3ZDLHdDQUF1QztBQUN2QyxzQ0FBcUM7QUFDckMsd0NBQXVDO0FBQ3ZDLDBDQUF5QztBQUN6QywrQkFBaUM7QUFDakMsaUNBQWdDO0FBQ2hDLHdDQUF3QztBQUV4QyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUE7QUFFZixNQUFhLHVCQUF3QixTQUFRLEdBQUcsQ0FBQyxLQUFLO0lBQ3BELFlBQVksS0FBb0IsRUFBRSxFQUFVLEVBQUUsS0FBc0I7UUFDbEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFFdkIsV0FBVztRQUNYLE1BQU0sYUFBYSxHQUFXLGFBQWEsQ0FBQTtRQUUzQyxhQUFhO1FBQ2IsTUFBTSxjQUFjLEdBQUcsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtZQUNoRSxjQUFjLEVBQUUsR0FBRyxhQUFhLFFBQVE7WUFDeEMsZUFBZSxFQUFFLElBQUk7WUFDckIsa0JBQWtCLEVBQUUsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPO1NBQzlDLENBQUMsQ0FBQTtRQUNGLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxhQUFhLG1CQUFtQixDQUFDLENBQUE7UUFFNUUsYUFBYTtRQUNiLE1BQU0sY0FBYyxHQUFHLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUU7WUFDaEUsY0FBYyxFQUFFLEdBQUcsYUFBYSxRQUFRO1lBQ3hDLGVBQWUsRUFBRSxJQUFJO1lBQ3JCLGtCQUFrQixFQUFFLEdBQUcs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QUFBO1FBQzVELE9BQU8sQ0FBQyxXQUFXLENBQUMsV0FBVyxHQUFHO1lBQ2hDLElBQUksRUFBRSxHQUFHO1lBQ1QsZ0JBQWdCLEVBQUUsS0FBSztZQUN2Qix1QkFBdUIsRUFBRSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxlQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUM3QixRQUFRLEVBQUUsZUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7U0FDaEMsQ0FBQTtRQUVELE9BQU8sQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFBO0lBQ25ELENBQUM7Q0FDRjtBQTdNRCwwREE2TUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSBcIkBhd3MtY2RrL2NvcmVcIlxuaW1wb3J0ICogYXMgZWMyIGZyb20gXCJAYXdzLWNkay9hd3MtZWMyXCJcbmltcG9ydCAqIGFzIGVjcyBmcm9tIFwiQGF3cy1jZGsvYXdzLWVjc1wiXG5pbXBvcnQgKiBhcyBlY3NfcGF0dGVybnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1lY3MtcGF0dGVybnNcIlxuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJAYXdzLWNkay9hd3MtaWFtXCJcbmltcG9ydCAqIGFzIGVjciBmcm9tIFwiQGF3cy1jZGsvYXdzLWVjclwiXG5pbXBvcnQgKiBhcyBzMyBmcm9tIFwiQGF3cy1jZGsvYXdzLXMzXCJcbmltcG9ydCAqIGFzIHJkcyBmcm9tIFwiQGF3cy1jZGsvYXdzLXJkc1wiXG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gXCJAYXdzLWNkay9hd3MtbG9nc1wiXG5pbXBvcnQgeyB2NCBhcyB1dWlkIH0gZnJvbSBcInV1aWRcIlxuaW1wb3J0ICogYXMgZG90ZW52IGZyb20gXCJkb3RlbnZcIlxuaW1wb3J0IHsgRHVyYXRpb24gfSBmcm9tIFwiQGF3cy1jZGsvY29yZVwiXG5cbmRvdGVudi5jb25maWcoKVxuXG5leHBvcnQgY2xhc3MgQXdzQ2RrRWNzT25GYXJnYXRlU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBjZGsuU3RhY2tQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpXG5cbiAgICAvLyBhcHAgbmFtZVxuICAgIGNvbnN0IHJlc291Y2VQcmVmaXg6IHN0cmluZyA9IFwicHJvamVjdG5hbWVcIlxuXG4gICAgLy8gRUNSKFJhaWxzKVxuICAgIGNvbnN0IHJhaWxzSW1hZ2VSZXBvID0gbmV3IGVjci5SZXBvc2l0b3J5KHRoaXMsIFwicmFpbHNJbWFnZVJlcG9cIiwge1xuICAgICAgcmVwb3NpdG9yeU5hbWU6IGAke3Jlc291Y2VQcmVmaXh9LXJhaWxzYCxcbiAgICAgIGltYWdlU2Nhbk9uUHVzaDogdHJ1ZSxcbiAgICAgIGltYWdlVGFnTXV0YWJpbGl0eTogZWNyLlRhZ011dGFiaWxpdHkuTVVUQUJMRVxuICAgIH0pXG4gICAgY2RrLlRhZ3Mub2YocmFpbHNJbWFnZVJlcG8pLmFkZChcIk5hbWVcIiwgYCR7cmVzb3VjZVByZWZpeH0tcmFpbHMtaW1hZ2UtcmVwb2ApXG5cbiAgICAvLyBFQ1IoTmdpbngpXG4gICAgY29uc3QgbmdpbnhJbWFnZVJlcG8gPSBuZXcgZWNyLlJlcG9zaXRvcnkodGhpcywgXCJuZ2lueEltYWdlUmVwb1wiLCB7XG4gICAgICByZXBvc2l0b3J5TmFtZTogYCR7cmVzb3VjZVByZWZpeH0tbmdpbnhgLFxuICAgICAgaW1hZ2VTY2FuT25QdXNoOiB0cnVlLFxuICAgICAgaW1hZ2VUYWdNdXRhYmlsaXR5OiBlY3IuVGFnTXV0YWJpbGl0eS5NVVRBQkxFXG4gICAgfSlcbiAgICBjZGsuVGFncy5vZihuZ2lueEltYWdlUmVwbykuYWRkKFwiTmFtZVwiLCBgJHtyZXNvdWNlUHJlZml4fS1uZ2lueC1pbWFnZS1yZXBvYClcblxuICAgIC8vIFZQQywgU3VibmV0cywgR1csIFJvdXRlVGFibGVcbiAgICBjb25zdCB2cGMgPSBuZXcgZWMyLlZwYyh0aGlzLCBcInZwY1wiLCB7XG4gICAgICBjaWRyOiBcIjEwLjAuMC4wLzE2XCIsXG4gICAgICBlbmFibGVEbnNIb3N0bmFtZXM6IHRydWUsXG4gICAgICBlbmFibGVEbnNTdXBwb3J0OiB0cnVlLFxuICAgICAgc3VibmV0Q29uZmlndXJhdGlvbjogW1xuICAgICAgICB7XG4gICAgICAgICAgY2lkck1hc2s6IDI0LFxuICAgICAgICAgIG5hbWU6IFwicHVibGljXCIsXG4gICAgICAgICAgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFVCTElDXG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9KVxuICAgIGNkay5UYWdzLm9mKHZwYykuYWRkKFwiTmFtZVwiLCBgJHtyZXNvdWNlUHJlZml4fS12cGNgKVxuXG4gICAgLy8gc2VjdXJpdHkgZ3JvdXAgZm9yIGFsYlxuICAgIGNvbnN0IGFsYlNnID0gbmV3IGVjMi5TZWN1cml0eUdyb3VwKHRoaXMsIFwiYWxiU2dcIiwge1xuICAgICAgdnBjLFxuICAgICAgYWxsb3dBbGxPdXRib3VuZDogdHJ1ZVxuICAgIH0pXG4gICAgYWxiU2cuYWRkSW5ncmVzc1J1bGUoZWMyLlBlZXIuYW55SXB2NCgpLCBlYzIuUG9ydC50Y3AoODApKVxuICAgIGFsYlNnLmFkZEVncmVzc1J1bGUoZWMyLlBlZXIuYW55SXB2NCgpLCBlYzIuUG9ydC5hbGxUcmFmZmljKCkpXG4gICAgY2RrLlRhZ3Mub2YoYWxiU2cpLmFkZChcIk5hbWVcIiwgYCR7cmVzb3VjZVByZWZpeH0tYWxiLVNnYClcblxuICAgIC8vIHNlY3VyaXR5IGdyb3VwIGZvciBkYlxuICAgIGNvbnN0IGRiU2cgPSBuZXcgZWMyLlNlY3VyaXR5R3JvdXAodGhpcywgXCJkYlNnXCIsIHtcbiAgICAgIHZwYyxcbiAgICAgIGFsbG93QWxsT3V0Ym91bmQ6IHRydWVcbiAgICB9KVxuICAgIGRiU2cuYWRkSW5ncmVzc1J1bGUoZWMyLlBlZXIuYW55SXB2NCgpLCBlYzIuUG9ydC50Y3AoNTQzMikpXG4gICAgZGJTZy5hZGRFZ3Jlc3NSdWxlKGVjMi5QZWVyLmFueUlwdjQoKSwgZWMyLlBvcnQuYWxsVHJhZmZpYygpKVxuICAgIGNkay5UYWdzLm9mKGRiU2cpLmFkZChcIk5hbWVcIiwgYCR7cmVzb3VjZVByZWZpeH0tZGItU2dgKVxuXG4gICAgLy8gcmRzXG4gICAgY29uc3QgZGIgPSBuZXcgcmRzLkRhdGFiYXNlSW5zdGFuY2UodGhpcywgXCJkYlwiLCB7XG4gICAgICB2cGMsXG4gICAgICB2cGNTdWJuZXRzOiB7XG4gICAgICAgIHN1Ym5ldHM6IHZwYy5wdWJsaWNTdWJuZXRzXG4gICAgICB9LFxuICAgICAgZW5naW5lOiByZHMuRGF0YWJhc2VJbnN0YW5jZUVuZ2luZS5wb3N0Z3Jlcyh7IHZlcnNpb246IHJkcy5Qb3N0Z3Jlc0VuZ2luZVZlcnNpb24uVkVSXzE0XzEgfSksXG4gICAgICBpbnN0YW5jZUlkZW50aWZpZXI6IGAke3Jlc291Y2VQcmVmaXh9LWRiYCxcbiAgICAgIGluc3RhbmNlVHlwZTogZWMyLkluc3RhbmNlVHlwZS5vZihlYzIuSW5zdGFuY2VDbGFzcy5UMywgZWMyLkluc3RhbmNlU2l6ZS5NSUNSTyksXG4gICAgICBhbGxvY2F0ZWRTdG9yYWdlOiAyMCxcbiAgICAgIHN0b3JhZ2VUeXBlOiByZHMuU3RvcmFnZVR5cGUuR1AyLFxuICAgICAgZGF0YWJhc2VOYW1lOiBwcm9jZXNzLmVudi5EQVRBQkFTRV9OQU1FIHx8IFwiXCIsXG4gICAgICBjcmVkZW50aWFsczoge1xuICAgICAgICB1c2VybmFtZTogcHJvY2Vzcy5lbnYuREFUQUJBU0VfVVNFUk5BTUUgfHwgXCJcIixcbiAgICAgICAgcGFzc3dvcmQ6IGNkay5TZWNyZXRWYWx1ZS5wbGFpblRleHQocHJvY2Vzcy5lbnYuREFUQUJBU0VfUEFTU1dPUkQgfHwgXCJcIilcbiAgICAgIH0sXG4gICAgICBwb3J0OiA1NDMyLFxuICAgICAgbXVsdGlBejogdHJ1ZSxcbiAgICAgIHNlY3VyaXR5R3JvdXBzOiBbZGJTZ11cbiAgICB9KVxuICAgIGNkay5UYWdzLm9mKGRiKS5hZGQoXCJOYW1lXCIsIGAke3Jlc291Y2VQcmVmaXh9LWRiYClcblxuICAgIC8vIGlhbVxuICAgIGNvbnN0IGVjc1Rhc2tFeGVjdXRpb25Sb2xlID0gbmV3IGlhbS5Sb2xlKHRoaXMsIFwiZWNzVGFza0V4ZWN1dGlvblJvbGVcIiwge1xuICAgICAgcm9sZU5hbWU6IFwiZWNzLXRhc2stZXhlY3V0aW9uLXJvbGVcIixcbiAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKFwiZWNzLXRhc2tzLmFtYXpvbmF3cy5jb21cIiksXG4gICAgICBtYW5hZ2VkUG9saWNpZXM6IFtcbiAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwic2VydmljZS1yb2xlL0FtYXpvbkVDU1Rhc2tFeGVjdXRpb25Sb2xlUG9saWN5XCIpLFxuICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoXCJBbWF6b25TU01SZWFkT25seUFjY2Vzc1wiKVxuICAgICAgXVxuICAgIH0pXG4gICAgY2RrLlRhZ3Mub2YoZWNzVGFza0V4ZWN1dGlvblJvbGUpLmFkZChcIk5hbWVcIiwgYCR7cmVzb3VjZVByZWZpeH0tZWNzLXRhc2stZXhlY3V0aW9uLXJvbGVgKVxuXG4gICAgLy8gY2x1c3RlclxuICAgIGNvbnN0IGNsdXN0ZXIgPSBuZXcgZWNzLkNsdXN0ZXIodGhpcywgXCJjbHVzdGVyXCIsIHtcbiAgICAgIHZwYyxcbiAgICAgIGNsdXN0ZXJOYW1lOiBgJHtyZXNvdWNlUHJlZml4fS1jbHVzdGVyYFxuICAgIH0pXG4gICAgY2RrLlRhZ3Mub2YoY2x1c3RlcikuYWRkKFwiTmFtZVwiLCBgJHtyZXNvdWNlUHJlZml4fS1jbHVzdGVyYClcblxuICAgIC8vIGxvZyBncm91cFxuICAgIGNvbnN0IGxvZ0dyb3VwID0gbmV3IGxvZ3MuTG9nR3JvdXAodGhpcywgXCJsb2dHcm91cFwiLCB7XG4gICAgICBsb2dHcm91cE5hbWU6IFwiL2F3cy9jZGsvZWNzL3Byb2plY3RuYW1lXCJcbiAgICB9KVxuICAgIGNkay5UYWdzLm9mKGxvZ0dyb3VwKS5hZGQoXCJOYW1lXCIsIGAke3Jlc291Y2VQcmVmaXh9LWxvZy1ncm91cGApXG5cbiAgICAvLyB0YXNrIGRlZmluaXRpb25cbiAgICBjb25zdCB0YXNrRGVmaW5pdGlvbiA9IG5ldyBlY3MuRmFyZ2F0ZVRhc2tEZWZpbml0aW9uKHRoaXMsIFwidGFza0RlZmluaXRpb25cIiwge1xuICAgICAgZmFtaWx5OiBgJHtyZXNvdWNlUHJlZml4fS1hcHAtbmdpbnhgLFxuICAgICAgY3B1OiA1MTIsXG4gICAgICBtZW1vcnlMaW1pdE1pQjogMTAyNCxcbiAgICAgIGV4ZWN1dGlvblJvbGU6IGVjc1Rhc2tFeGVjdXRpb25Sb2xlLFxuICAgICAgdGFza1JvbGU6IGVjc1Rhc2tFeGVjdXRpb25Sb2xlXG4gICAgfSlcbiAgICBjZGsuVGFncy5vZih0YXNrRGVmaW5pdGlvbikuYWRkKFwiTmFtZVwiLCBgJHtyZXNvdWNlUHJlZml4fS10YXNrLWRlZmluaXRpb25gKVxuXG4gICAgLy8gcmFpbHMgY29udGFpbmVyXG4gICAgY29uc3QgcmFpbHNDb250YWluZXIgPSBuZXcgZWNzLkNvbnRhaW5lckRlZmluaXRpb24odGhpcywgXCJyYWlsc0NvbnRhaW5lclwiLCB7XG4gICAgICBjb250YWluZXJOYW1lOiBcInJhaWxzXCIsXG4gICAgICB0YXNrRGVmaW5pdGlvbixcbiAgICAgIGltYWdlOiBlY3MuQ29udGFpbmVySW1hZ2UuZnJvbUVjclJlcG9zaXRvcnkoXG4gICAgICAgIGVjci5SZXBvc2l0b3J5LmZyb21SZXBvc2l0b3J5TmFtZSh0aGlzLCBcInJhaWxzSW1hZ2VcIiwgYCR7cmVzb3VjZVByZWZpeH0tcmFpbHNgKVxuICAgICAgKSxcbiAgICAgIGxvZ2dpbmc6IGVjcy5Mb2dEcml2ZXIuYXdzTG9ncyh7XG4gICAgICAgIHN0cmVhbVByZWZpeDogXCJwcm9kdWN0aW9uXCIsXG4gICAgICAgIGxvZ0dyb3VwXG4gICAgICB9KSxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIERBVEFCQVNFX0hPU1Q6IGRiLmRiSW5zdGFuY2VFbmRwb2ludEFkZHJlc3MsXG4gICAgICAgIERBVEFCQVNFX05BTUU6IHByb2Nlc3MuZW52LkRBVEFCQVNFX05BTUUgfHwgXCJcIixcbiAgICAgICAgREFUQUJBU0VfUEFTU1dPUkQ6IHByb2Nlc3MuZW52LkRBVEFCQVNFX1BBU1NXT1JEIHx8IFwiXCIsXG4gICAgICAgIERBVEFCQVNFX1VTRVJOQU1FOiBwcm9jZXNzLmVudi5EQVRBQkFTRV9VU0VSTkFNRSB8fCBcIlwiLFxuICAgICAgICBSQUlMU19FTlY6IFwicHJvZHVjdGlvblwiLFxuICAgICAgICBSQUlMU19NQVNURVJfS0VZOiBwcm9jZXNzLmVudi5SQUlMU19NQVNURVJfS0VZIHx8IFwiXCIsXG4gICAgICAgIFRaOiBcIkphcGFuXCJcbiAgICAgIH0sXG4gICAgICBjb21tYW5kOiBbXG4gICAgICAgIFwiYmFzaFwiLFxuICAgICAgICBcIi1jXCIsXG4gICAgICAgIFwiIFxcXG4gICAgICAgICAgYnVuZGxlIGluc3RhbGwgJiYgXFxcbiAgICAgICAgICBidW5kbGUgZXhlYyByaWRnZXBvbGUgLS1jb25maWcgLi9jb25maWcvZGF0YWJhc2UueW1sIC0tZmlsZSAuL2RiL3NjaGVtYWZpbGUucmIgLUUgcHJvZHVjdGlvbiAtLWFwcGx5ICYmIFxcXG4gICAgICAgICAgcm0gLWYgdG1wL3BpZHMvc2VydmVyLnBpZCAmJiBcXFxuICAgICAgICAgIGJ1bmRsZSBleGVjIHJhaWxzIGFzc2V0czpwcmVjb21waWxlICYmIFxcXG4gICAgICAgICAgYnVuZGxlIGV4ZWMgcmFpbHMgc2VydmVyIC1lIHByb2R1Y3Rpb24gXFxcbiAgICAgICAgXCJcbiAgICAgIF0sXG4gICAgICB3b3JraW5nRGlyZWN0b3J5OiBcIi9hcHBfcm9vdFwiLFxuICAgICAgZXNzZW50aWFsOiB0cnVlXG4gICAgfSlcblxuICAgIC8vIG5naW54IGNvbnRhaW5lclxuICAgIGNvbnN0IG5naW54Q29udGFpbmVyID0gbmV3IGVjcy5Db250YWluZXJEZWZpbml0aW9uKHRoaXMsIFwibmdpbnhDb250YWluZXJcIiwge1xuICAgICAgY29udGFpbmVyTmFtZTogXCJuZ2lueFwiLFxuICAgICAgdGFza0RlZmluaXRpb24sXG4gICAgICBpbWFnZTogZWNzLkNvbnRhaW5lckltYWdlLmZyb21FY3JSZXBvc2l0b3J5KFxuICAgICAgICBlY3IuUmVwb3NpdG9yeS5mcm9tUmVwb3NpdG9yeU5hbWUodGhpcywgXCJuZ2lueEltYWdlXCIsIGAke3Jlc291Y2VQcmVmaXh9LW5naW54YClcbiAgICAgICksXG4gICAgICBsb2dnaW5nOiBlY3MuTG9nRHJpdmVyLmF3c0xvZ3Moe1xuICAgICAgICBzdHJlYW1QcmVmaXg6IFwicHJvZHVjdGlvblwiLFxuICAgICAgICBsb2dHcm91cFxuICAgICAgfSksXG4gICAgICBwb3J0TWFwcGluZ3M6IFtcbiAgICAgICAge1xuICAgICAgICAgIHByb3RvY29sOiBlY3MuUHJvdG9jb2wuVENQLFxuICAgICAgICAgIGNvbnRhaW5lclBvcnQ6IDgwXG4gICAgICAgIH1cbiAgICAgIF0sXG4gICAgICB3b3JraW5nRGlyZWN0b3J5OiBcIi9hcHBfcm9vdFwiLFxuICAgICAgZXNzZW50aWFsOiB0cnVlXG4gICAgfSlcblxuICAgIC8vIHNoYXJlIHZvbHVtZVxuICAgIG5naW54Q29udGFpbmVyLmFkZFZvbHVtZXNGcm9tKHtcbiAgICAgIHNvdXJjZUNvbnRhaW5lcjogXCJyYWlsc1wiLFxuICAgICAgcmVhZE9ubHk6IGZhbHNlXG4gICAgfSlcblxuICAgIC8vIHNwZWNpZnkgZGVmYXVsdCBjb250YWluZXJcbiAgICB0YXNrRGVmaW5pdGlvbi5kZWZhdWx0Q29udGFpbmVyID0gbmdpbnhDb250YWluZXJcblxuICAgIC8vIFMzIGZvciBsb2dzXG4gICAgY29uc3QgYWxiTG9nc0J1Y2tldCA9IG5ldyBzMy5CdWNrZXQodGhpcywgYGFsYi1sb2dzLWJ1Y2tldC0ke3V1aWQoKX1gKVxuICAgIGNkay5UYWdzLm9mKGFsYkxvZ3NCdWNrZXQpLmFkZChcIk5hbWVcIiwgYCR7cmVzb3VjZVByZWZpeH0tYWxiLWxvZ3MtYnVja2V0YClcblxuICAgIC8vIGxiLCB0YXJnZXQgZ3JvdXAsIHNlcnZpY2VcbiAgICBsZXQgc2VydmljZSA9IG5ldyBlY3NfcGF0dGVybnMuQXBwbGljYXRpb25Mb2FkQmFsYW5jZWRGYXJnYXRlU2VydmljZSh0aGlzLCBcInNlcnZpY2VcIiwge1xuICAgICAgc2VydmljZU5hbWU6IGAke3Jlc291Y2VQcmVmaXh9LXNlcnZpY2VgLFxuICAgICAgY2x1c3RlcixcbiAgICAgIHRhc2tEZWZpbml0aW9uLFxuICAgICAgZGVzaXJlZENvdW50OiAxLFxuICAgICAgbWluSGVhbHRoeVBlcmNlbnQ6IDEwMCxcbiAgICAgIG1heEhlYWx0aHlQZXJjZW50OiAyMDAsXG4gICAgICBhc3NpZ25QdWJsaWNJcDogdHJ1ZSxcbiAgICAgIGhlYWx0aENoZWNrR3JhY2VQZXJpb2Q6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDMwMCksXG4gICAgICBwdWJsaWNMb2FkQmFsYW5jZXI6IHRydWUsXG4gICAgICBzZWN1cml0eUdyb3VwczogW2FsYlNnLCBkYlNnXVxuICAgIH0pXG4gICAgY2RrLlRhZ3Mub2Yoc2VydmljZSkuYWRkKFwiTmFtZVwiLCBgJHtyZXNvdWNlUHJlZml4fS1zZXJ2aWNlYClcbiAgICBzZXJ2aWNlLnRhcmdldEdyb3VwLmhlYWx0aENoZWNrID0ge1xuICAgICAgcGF0aDogXCIvXCIsXG4gICAgICBoZWFsdGh5SHR0cENvZGVzOiBcIjIwMFwiLFxuICAgICAgdW5oZWFsdGh5VGhyZXNob2xkQ291bnQ6IDUsXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKDE1KSxcbiAgICAgIGludGVydmFsOiBEdXJhdGlvbi5zZWNvbmRzKDEyMCksXG4gICAgfVxuXG4gICAgc2VydmljZS5sb2FkQmFsYW5jZXIubG9nQWNjZXNzTG9ncyhhbGJMb2dzQnVja2V0KVxuICB9XG59Il19