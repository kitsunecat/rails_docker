"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AwsCdkEcsOnFargateStack = void 0;
const cdk = require("@aws-cdk/core");
const ec2 = require("@aws-cdk/aws-ec2");
const ecs = require("@aws-cdk/aws-ecs");
const ecs_patterns = require("@aws-cdk/aws-ecs-patterns");
const iam = require("@aws-cdk/aws-iam");
const ecr = require("@aws-cdk/aws-ecr");
const s3 = require("@aws-cdk/aws-s3");
const rds = require("@aws-cdk/aws-rds");
const logs = require("@aws-cdk/aws-logs");
const uuid_1 = require("uuid");
const dotenv = require("dotenv");
const core_1 = require("@aws-cdk/core");
dotenv.config();
class AwsCdkEcsOnFargateStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        // app name
        const resoucePrefix = "projectname";
        // ECR(Rails)
        const railsImageRepo = new ecr.Repository(this, "railsImageRepo", {
            repositoryName: `${resoucePrefix}-rails`,
            imageScanOnPush: true,
            imageTagMutability: ecr.TagMutability.MUTABLE
        });
        cdk.Tags.of(railsImageRepo).add("Name", `${resoucePrefix}-rails-image-repo`);
        // ECR(Nginx)
        const nginxImageRepo = new ecr.Repository(this, "nginxImageRepo", {
            repositoryName: `${resoucePrefix}-nginx`,
            imageScanOnPush: true,
            imageTagMutability: ecr.TagMutability.MUTABLE
        });
        cdk.Tags.of(nginxImageRepo).add("Name", `${resoucePrefix}-nginx-image-repo`);
        // VPC, Subnets, GW, RouteTable
        const vpc = new ec2.Vpc(this, "vpc", {
            cidr: "10.0.0.0/16",
            enableDnsHostnames: true,
            enableDnsSupport: true,
            subnetConfiguration: [
                {
                    cidrMask: 24,
                    name: "public",
                    subnetType: ec2.SubnetType.PUBLIC
                }
            ]
        });
        cdk.Tags.of(vpc).add("Name", `${resoucePrefix}-vpc`);
        // security group for alb
        const albSg = new ec2.SecurityGroup(this, "albSg", {
            vpc,
            allowAllOutbound: true
        });
        albSg.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(80));
        albSg.addEgressRule(ec2.Peer.anyIpv4(), ec2.Port.allTraffic());
        cdk.Tags.of(albSg).add("Name", `${resoucePrefix}-alb-Sg`);
        // security group for db
        const dbSg = new ec2.SecurityGroup(this, "dbSg", {
            vpc,
            allowAllOutbound: true
        });
        dbSg.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(5432));
        dbSg.addEgressRule(ec2.Peer.anyIpv4(), ec2.Port.allTraffic());
        cdk.Tags.of(dbSg).add("Name", `${resoucePrefix}-db-Sg`);
        // rds
        const db = new rds.DatabaseInstance(this, "db", {
            vpc,
            vpcSubnets: {
                subnets: vpc.publicSubnets
            },
            engine: rds.DatabaseInstanceEngine.postgres({ version: rds.PostgresEngineVersion.VER_14_1 }),
            instanceIdentifier: `${resoucePrefix}-db`,
            instanceType: ec2.InstanceType.of(ec2.InstanceClass.T3, ec2.InstanceSize.MICRO),
            allocatedStorage: 20,
            storageType: rds.StorageType.GP2,
            databaseName: process.env.DATABASE_NAME || "",
            credentials: {
                username: process.env.DATABASE_USERNAME || "",
                password: cdk.SecretValue.plainText(process.env.DATABASE_PASSWORD || "")
            },
            port: 5432,
            multiAz: true,
            securityGroups: [dbSg]
        });
        cdk.Tags.of(db).add("Name", `${resoucePrefix}-db`);
        // iam
        const ecsTaskExecutionRole = new iam.Role(this, "ecsTaskExecutionRole", {
            roleName: "ecs-task-execution-role",
            assumedBy: new iam.ServicePrincipal("ecs-tasks.amazonaws.com"),
            managedPolicies: [
                iam.ManagedPolicy.fromAwsManagedPolicyName("service-role/AmazonECSTaskExecutionRolePolicy"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonSSMReadOnlyAccess")
            ]
        });
        cdk.Tags.of(ecsTaskExecutionRole).add("Name", `${resoucePrefix}-ecs-task-execution-role`);
        // cluster
        const cluster = new ecs.Cluster(this, "cluster", {
            vpc,
            clusterName: `${resoucePrefix}-cluster`
        });
        cdk.Tags.of(cluster).add("Name", `${resoucePrefix}-cluster`);
        // log group
        const logGroup = new logs.LogGroup(this, "logGroup", {
            logGroupName: "/aws/cdk/ecs/projectname"
        });
        cdk.Tags.of(logGroup).add("Name", `${resoucePrefix}-log-group`);
        // task definition
        const taskDefinition = new ecs.FargateTaskDefinition(this, "taskDefinition", {
            family: `${resoucePrefix}-app-nginx`,
            cpu: 512,
            memoryLimitMiB: 1024,
            executionRole: ecsTaskExecutionRole,
            taskRole: ecsTaskExecutionRole
        });
        cdk.Tags.of(taskDefinition).add("Name", `${resoucePrefix}-task-definition`);
        // rails container
        const railsContainer = new ecs.ContainerDefinition(this, "railsContainer", {
            containerName: "rails",
            taskDefinition,
            image: ecs.ContainerImage.fromEcrRepository(ecr.Repository.fromRepositoryName(this, "railsImage", `${resoucePrefix}-rails`)),
            logging: ecs.LogDriver.awsLogs({
                streamPrefix: "production",
                logGroup
            }),
            environment: {
                DATABASE_HOST: db.dbInstanceEndpointAddress,
                DATABASE_NAME: process.env.DATABASE_NAME || "",
                DATABASE_PASSWORD: process.env.DATABASE_PASSWORD || "",
                DATABASE_USERNAME: process.env.DATABASE_USERNAME || "",
                RAILS_ENV: "production",
                RAILS_MASTER_KEY: process.env.RAILS_MASTER_KEY || "",
                TZ: "Japan"
            },
            command: [
                "bash",
                "-c",
                " \
          bundle install && \
          bundle exec ridgepole --config ./config/database.yml --file ./db/schemafile.rb -E production --apply && \
          rm -f tmp/pids/server.pid && \
          bundle exec rails server -e production \
        "
            ],
            workingDirectory: "/app_root",
            essential: true
        });
        // nginx container
        const nginxContainer = new ecs.ContainerDefinition(this, "nginxContainer", {
            containerName: "nginx",
            taskDefinition,
            image: ecs.ContainerImage.fromEcrRepository(ecr.Repository.fromRepositoryName(this, "nginxImage", `${resoucePrefix}-nginx`)),
            logging: ecs.LogDriver.awsLogs({
                streamPrefix: "production",
                logGroup
            }),
            portMappings: [
                {
                    protocol: ecs.Protocol.TCP,
                    containerPort: 80
                }
            ],
            workingDirectory: "/app_root",
            essential: true
        });
        // share volume
        nginxContainer.addVolumesFrom({
            sourceContainer: "rails",
            readOnly: false
        });
        // specify default container
        taskDefinition.defaultContainer = nginxContainer;
        // S3 for logs
        const albLogsBucket = new s3.Bucket(this, `alb-logs-bucket-${uuid_1.v4()}`);
        cdk.Tags.of(albLogsBucket).add("Name", `${resoucePrefix}-alb-logs-bucket`);
        // lb, target group, service
        let service = new ecs_patterns.ApplicationLoadBalancedFargateService(this, "service", {
            serviceName: `${resoucePrefix}-service`,
            cluster,
            taskDefinition,
            desiredCount: 1,
            minHealthyPercent: 100,
            maxHealthyPercent: 200,
            assignPublicIp: true,
            healthCheckGracePeriod: cdk.Duration.seconds(300),
            publicLoadBalancer: true,
            securityGroups: [albSg, dbSg]
        });
        cdk.Tags.of(service).add("Name", `${resoucePrefix}-service`);
        service.targetGroup.healthCheck = {
            path: "/",
            healthyHttpCodes: "200",
            unhealthyThresholdCount: 5,
            timeout: core_1.Duration.seconds(15),
            interval: core_1.Duration.seconds(120),
        };
        service.loadBalancer.logAccessLogs(albLogsBucket);
    }
}
exports.AwsCdkEcsOnFargateStack = AwsCdkEcsOnFargateStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5mcmEtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmZyYS1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBb0M7QUFDcEMsd0NBQXVDO0FBQ3ZDLHdDQUF1QztBQUN2QywwREFBeUQ7QUFDekQsd0NBQXVDO0FBQ3ZDLHdDQUF1QztBQUN2QyxzQ0FBcUM7QUFDckMsd0NBQXVDO0FBQ3ZDLDBDQUF5QztBQUN6QywrQkFBaUM7QUFDakMsaUNBQWdDO0FBQ2hDLHdDQUF3QztBQUV4QyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUE7QUFFZixNQUFhLHVCQUF3QixTQUFRLEdBQUcsQ0FBQyxLQUFLO0lBQ3BELFlBQVksS0FBb0IsRUFBRSxFQUFVLEVBQUUsS0FBc0I7UUFDbEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFFdkIsV0FBVztRQUNYLE1BQU0sYUFBYSxHQUFXLGFBQWEsQ0FBQTtRQUUzQyxhQUFhO1FBQ2IsTUFBTSxjQUFjLEdBQUcsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtZQUNoRSxjQUFjLEVBQUUsR0FBRyxhQUFhLFFBQVE7WUFDeEMsZUFBZSxFQUFFLElBQUk7WUFDckIsa0JBQWtCLEVBQUUsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPO1NBQzlDLENBQUMsQ0FBQTtRQUNGLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxhQUFhLG1CQUFtQixDQUFDLENBQUE7UUFFNUUsYUFBYTtRQUNiLE1BQU0sY0FBYyxHQUFHLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUU7WUFDaEUsY0FBYyxFQUFFLEdBQUcsYUFBYSxRQUFRO1lBQ3hDLGVBQWUsRUFBRSxJQUFJO1lBQ3JCLGtCQUFrQixFQUFFLEdBQUcs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QUE7UUFDNUQsT0FBTyxDQUFDLFdBQVcsQ0FBQyxXQUFXLEdBQUc7WUFDaEMsSUFBSSxFQUFFLEdBQUc7WUFDVCxnQkFBZ0IsRUFBRSxLQUFLO1lBQ3ZCLHVCQUF1QixFQUFFLENBQUM7WUFDMUIsT0FBTyxFQUFFLGVBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQzdCLFFBQVEsRUFBRSxlQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQztTQUNoQyxDQUFBO1FBRUQsT0FBTyxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUE7SUFDbkQsQ0FBQztDQUNGO0FBNU1ELDBEQTRNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tIFwiQGF3cy1jZGsvY29yZVwiXG5pbXBvcnQgKiBhcyBlYzIgZnJvbSBcIkBhd3MtY2RrL2F3cy1lYzJcIlxuaW1wb3J0ICogYXMgZWNzIGZyb20gXCJAYXdzLWNkay9hd3MtZWNzXCJcbmltcG9ydCAqIGFzIGVjc19wYXR0ZXJucyBmcm9tIFwiQGF3cy1jZGsvYXdzLWVjcy1wYXR0ZXJuc1wiXG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcIkBhd3MtY2RrL2F3cy1pYW1cIlxuaW1wb3J0ICogYXMgZWNyIGZyb20gXCJAYXdzLWNkay9hd3MtZWNyXCJcbmltcG9ydCAqIGFzIHMzIGZyb20gXCJAYXdzLWNkay9hd3MtczNcIlxuaW1wb3J0ICogYXMgcmRzIGZyb20gXCJAYXdzLWNkay9hd3MtcmRzXCJcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcIkBhd3MtY2RrL2F3cy1sb2dzXCJcbmltcG9ydCB7IHY0IGFzIHV1aWQgfSBmcm9tIFwidXVpZFwiXG5pbXBvcnQgKiBhcyBkb3RlbnYgZnJvbSBcImRvdGVudlwiXG5pbXBvcnQgeyBEdXJhdGlvbiB9IGZyb20gXCJAYXdzLWNkay9jb3JlXCJcblxuZG90ZW52LmNvbmZpZygpXG5cbmV4cG9ydCBjbGFzcyBBd3NDZGtFY3NPbkZhcmdhdGVTdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IGNkay5TdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcylcblxuICAgIC8vIGFwcCBuYW1lXG4gICAgY29uc3QgcmVzb3VjZVByZWZpeDogc3RyaW5nID0gXCJwcm9qZWN0bmFtZVwiXG5cbiAgICAvLyBFQ1IoUmFpbHMpXG4gICAgY29uc3QgcmFpbHNJbWFnZVJlcG8gPSBuZXcgZWNyLlJlcG9zaXRvcnkodGhpcywgXCJyYWlsc0ltYWdlUmVwb1wiLCB7XG4gICAgICByZXBvc2l0b3J5TmFtZTogYCR7cmVzb3VjZVByZWZpeH0tcmFpbHNgLFxuICAgICAgaW1hZ2VTY2FuT25QdXNoOiB0cnVlLFxuICAgICAgaW1hZ2VUYWdNdXRhYmlsaXR5OiBlY3IuVGFnTXV0YWJpbGl0eS5NVVRBQkxFXG4gICAgfSlcbiAgICBjZGsuVGFncy5vZihyYWlsc0ltYWdlUmVwbykuYWRkKFwiTmFtZVwiLCBgJHtyZXNvdWNlUHJlZml4fS1yYWlscy1pbWFnZS1yZXBvYClcblxuICAgIC8vIEVDUihOZ2lueClcbiAgICBjb25zdCBuZ2lueEltYWdlUmVwbyA9IG5ldyBlY3IuUmVwb3NpdG9yeSh0aGlzLCBcIm5naW54SW1hZ2VSZXBvXCIsIHtcbiAgICAgIHJlcG9zaXRvcnlOYW1lOiBgJHtyZXNvdWNlUHJlZml4fS1uZ2lueGAsXG4gICAgICBpbWFnZVNjYW5PblB1c2g6IHRydWUsXG4gICAgICBpbWFnZVRhZ011dGFiaWxpdHk6IGVjci5UYWdNdXRhYmlsaXR5Lk1VVEFCTEVcbiAgICB9KVxuICAgIGNkay5UYWdzLm9mKG5naW54SW1hZ2VSZXBvKS5hZGQoXCJOYW1lXCIsIGAke3Jlc291Y2VQcmVmaXh9LW5naW54LWltYWdlLXJlcG9gKVxuXG4gICAgLy8gVlBDLCBTdWJuZXRzLCBHVywgUm91dGVUYWJsZVxuICAgIGNvbnN0IHZwYyA9IG5ldyBlYzIuVnBjKHRoaXMsIFwidnBjXCIsIHtcbiAgICAgIGNpZHI6IFwiMTAuMC4wLjAvMTZcIixcbiAgICAgIGVuYWJsZURuc0hvc3RuYW1lczogdHJ1ZSxcbiAgICAgIGVuYWJsZURuc1N1cHBvcnQ6IHRydWUsXG4gICAgICBzdWJuZXRDb25maWd1cmF0aW9uOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBjaWRyTWFzazogMjQsXG4gICAgICAgICAgbmFtZTogXCJwdWJsaWNcIixcbiAgICAgICAgICBzdWJuZXRUeXBlOiBlYzIuU3VibmV0VHlwZS5QVUJMSUNcbiAgICAgICAgfVxuICAgICAgXVxuICAgIH0pXG4gICAgY2RrLlRhZ3Mub2YodnBjKS5hZGQoXCJOYW1lXCIsIGAke3Jlc291Y2VQcmVmaXh9LXZwY2ApXG5cbiAgICAvLyBzZWN1cml0eSBncm91cCBmb3IgYWxiXG4gICAgY29uc3QgYWxiU2cgPSBuZXcgZWMyLlNlY3VyaXR5R3JvdXAodGhpcywgXCJhbGJTZ1wiLCB7XG4gICAgICB2cGMsXG4gICAgICBhbGxvd0FsbE91dGJvdW5kOiB0cnVlXG4gICAgfSlcbiAgICBhbGJTZy5hZGRJbmdyZXNzUnVsZShlYzIuUGVlci5hbnlJcHY0KCksIGVjMi5Qb3J0LnRjcCg4MCkpXG4gICAgYWxiU2cuYWRkRWdyZXNzUnVsZShlYzIuUGVlci5hbnlJcHY0KCksIGVjMi5Qb3J0LmFsbFRyYWZmaWMoKSlcbiAgICBjZGsuVGFncy5vZihhbGJTZykuYWRkKFwiTmFtZVwiLCBgJHtyZXNvdWNlUHJlZml4fS1hbGItU2dgKVxuXG4gICAgLy8gc2VjdXJpdHkgZ3JvdXAgZm9yIGRiXG4gICAgY29uc3QgZGJTZyA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cCh0aGlzLCBcImRiU2dcIiwge1xuICAgICAgdnBjLFxuICAgICAgYWxsb3dBbGxPdXRib3VuZDogdHJ1ZVxuICAgIH0pXG4gICAgZGJTZy5hZGRJbmdyZXNzUnVsZShlYzIuUGVlci5hbnlJcHY0KCksIGVjMi5Qb3J0LnRjcCg1NDMyKSlcbiAgICBkYlNnLmFkZEVncmVzc1J1bGUoZWMyLlBlZXIuYW55SXB2NCgpLCBlYzIuUG9ydC5hbGxUcmFmZmljKCkpXG4gICAgY2RrLlRhZ3Mub2YoZGJTZykuYWRkKFwiTmFtZVwiLCBgJHtyZXNvdWNlUHJlZml4fS1kYi1TZ2ApXG5cbiAgICAvLyByZHNcbiAgICBjb25zdCBkYiA9IG5ldyByZHMuRGF0YWJhc2VJbnN0YW5jZSh0aGlzLCBcImRiXCIsIHtcbiAgICAgIHZwYyxcbiAgICAgIHZwY1N1Ym5ldHM6IHtcbiAgICAgICAgc3VibmV0czogdnBjLnB1YmxpY1N1Ym5ldHNcbiAgICAgIH0sXG4gICAgICBlbmdpbmU6IHJkcy5EYXRhYmFzZUluc3RhbmNlRW5naW5lLnBvc3RncmVzKHsgdmVyc2lvbjogcmRzLlBvc3RncmVzRW5naW5lVmVyc2lvbi5WRVJfMTRfMSB9KSxcbiAgICAgIGluc3RhbmNlSWRlbnRpZmllcjogYCR7cmVzb3VjZVByZWZpeH0tZGJgLFxuICAgICAgaW5zdGFuY2VUeXBlOiBlYzIuSW5zdGFuY2VUeXBlLm9mKGVjMi5JbnN0YW5jZUNsYXNzLlQzLCBlYzIuSW5zdGFuY2VTaXplLk1JQ1JPKSxcbiAgICAgIGFsbG9jYXRlZFN0b3JhZ2U6IDIwLFxuICAgICAgc3RvcmFnZVR5cGU6IHJkcy5TdG9yYWdlVHlwZS5HUDIsXG4gICAgICBkYXRhYmFzZU5hbWU6IHByb2Nlc3MuZW52LkRBVEFCQVNFX05BTUUgfHwgXCJcIixcbiAgICAgIGNyZWRlbnRpYWxzOiB7XG4gICAgICAgIHVzZXJuYW1lOiBwcm9jZXNzLmVudi5EQVRBQkFTRV9VU0VSTkFNRSB8fCBcIlwiLFxuICAgICAgICBwYXNzd29yZDogY2RrLlNlY3JldFZhbHVlLnBsYWluVGV4dChwcm9jZXNzLmVudi5EQVRBQkFTRV9QQVNTV09SRCB8fCBcIlwiKVxuICAgICAgfSxcbiAgICAgIHBvcnQ6IDU0MzIsXG4gICAgICBtdWx0aUF6OiB0cnVlLFxuICAgICAgc2VjdXJpdHlHcm91cHM6IFtkYlNnXVxuICAgIH0pXG4gICAgY2RrLlRhZ3Mub2YoZGIpLmFkZChcIk5hbWVcIiwgYCR7cmVzb3VjZVByZWZpeH0tZGJgKVxuXG4gICAgLy8gaWFtXG4gICAgY29uc3QgZWNzVGFza0V4ZWN1dGlvblJvbGUgPSBuZXcgaWFtLlJvbGUodGhpcywgXCJlY3NUYXNrRXhlY3V0aW9uUm9sZVwiLCB7XG4gICAgICByb2xlTmFtZTogXCJlY3MtdGFzay1leGVjdXRpb24tcm9sZVwiLFxuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoXCJlY3MtdGFza3MuYW1hem9uYXdzLmNvbVwiKSxcbiAgICAgIG1hbmFnZWRQb2xpY2llczogW1xuICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoXCJzZXJ2aWNlLXJvbGUvQW1hem9uRUNTVGFza0V4ZWN1dGlvblJvbGVQb2xpY3lcIiksXG4gICAgICAgIGlhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZShcIkFtYXpvblNTTVJlYWRPbmx5QWNjZXNzXCIpXG4gICAgICBdXG4gICAgfSlcbiAgICBjZGsuVGFncy5vZihlY3NUYXNrRXhlY3V0aW9uUm9sZSkuYWRkKFwiTmFtZVwiLCBgJHtyZXNvdWNlUHJlZml4fS1lY3MtdGFzay1leGVjdXRpb24tcm9sZWApXG5cbiAgICAvLyBjbHVzdGVyXG4gICAgY29uc3QgY2x1c3RlciA9IG5ldyBlY3MuQ2x1c3Rlcih0aGlzLCBcImNsdXN0ZXJcIiwge1xuICAgICAgdnBjLFxuICAgICAgY2x1c3Rlck5hbWU6IGAke3Jlc291Y2VQcmVmaXh9LWNsdXN0ZXJgXG4gICAgfSlcbiAgICBjZGsuVGFncy5vZihjbHVzdGVyKS5hZGQoXCJOYW1lXCIsIGAke3Jlc291Y2VQcmVmaXh9LWNsdXN0ZXJgKVxuXG4gICAgLy8gbG9nIGdyb3VwXG4gICAgY29uc3QgbG9nR3JvdXAgPSBuZXcgbG9ncy5Mb2dHcm91cCh0aGlzLCBcImxvZ0dyb3VwXCIsIHtcbiAgICAgIGxvZ0dyb3VwTmFtZTogXCIvYXdzL2Nkay9lY3MvcHJvamVjdG5hbWVcIlxuICAgIH0pXG4gICAgY2RrLlRhZ3Mub2YobG9nR3JvdXApLmFkZChcIk5hbWVcIiwgYCR7cmVzb3VjZVByZWZpeH0tbG9nLWdyb3VwYClcblxuICAgIC8vIHRhc2sgZGVmaW5pdGlvblxuICAgIGNvbnN0IHRhc2tEZWZpbml0aW9uID0gbmV3IGVjcy5GYXJnYXRlVGFza0RlZmluaXRpb24odGhpcywgXCJ0YXNrRGVmaW5pdGlvblwiLCB7XG4gICAgICBmYW1pbHk6IGAke3Jlc291Y2VQcmVmaXh9LWFwcC1uZ2lueGAsXG4gICAgICBjcHU6IDUxMixcbiAgICAgIG1lbW9yeUxpbWl0TWlCOiAxMDI0LFxuICAgICAgZXhlY3V0aW9uUm9sZTogZWNzVGFza0V4ZWN1dGlvblJvbGUsXG4gICAgICB0YXNrUm9sZTogZWNzVGFza0V4ZWN1dGlvblJvbGVcbiAgICB9KVxuICAgIGNkay5UYWdzLm9mKHRhc2tEZWZpbml0aW9uKS5hZGQoXCJOYW1lXCIsIGAke3Jlc291Y2VQcmVmaXh9LXRhc2stZGVmaW5pdGlvbmApXG5cbiAgICAvLyByYWlscyBjb250YWluZXJcbiAgICBjb25zdCByYWlsc0NvbnRhaW5lciA9IG5ldyBlY3MuQ29udGFpbmVyRGVmaW5pdGlvbih0aGlzLCBcInJhaWxzQ29udGFpbmVyXCIsIHtcbiAgICAgIGNvbnRhaW5lck5hbWU6IFwicmFpbHNcIixcbiAgICAgIHRhc2tEZWZpbml0aW9uLFxuICAgICAgaW1hZ2U6IGVjcy5Db250YWluZXJJbWFnZS5mcm9tRWNyUmVwb3NpdG9yeShcbiAgICAgICAgZWNyLlJlcG9zaXRvcnkuZnJvbVJlcG9zaXRvcnlOYW1lKHRoaXMsIFwicmFpbHNJbWFnZVwiLCBgJHtyZXNvdWNlUHJlZml4fS1yYWlsc2ApXG4gICAgICApLFxuICAgICAgbG9nZ2luZzogZWNzLkxvZ0RyaXZlci5hd3NMb2dzKHtcbiAgICAgICAgc3RyZWFtUHJlZml4OiBcInByb2R1Y3Rpb25cIixcbiAgICAgICAgbG9nR3JvdXBcbiAgICAgIH0pLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgREFUQUJBU0VfSE9TVDogZGIuZGJJbnN0YW5jZUVuZHBvaW50QWRkcmVzcyxcbiAgICAgICAgREFUQUJBU0VfTkFNRTogcHJvY2Vzcy5lbnYuREFUQUJBU0VfTkFNRSB8fCBcIlwiLFxuICAgICAgICBEQVRBQkFTRV9QQVNTV09SRDogcHJvY2Vzcy5lbnYuREFUQUJBU0VfUEFTU1dPUkQgfHwgXCJcIixcbiAgICAgICAgREFUQUJBU0VfVVNFUk5BTUU6IHByb2Nlc3MuZW52LkRBVEFCQVNFX1VTRVJOQU1FIHx8IFwiXCIsXG4gICAgICAgIFJBSUxTX0VOVjogXCJwcm9kdWN0aW9uXCIsXG4gICAgICAgIFJBSUxTX01BU1RFUl9LRVk6IHByb2Nlc3MuZW52LlJBSUxTX01BU1RFUl9LRVkgfHwgXCJcIixcbiAgICAgICAgVFo6IFwiSmFwYW5cIlxuICAgICAgfSxcbiAgICAgIGNvbW1hbmQ6IFtcbiAgICAgICAgXCJiYXNoXCIsXG4gICAgICAgIFwiLWNcIixcbiAgICAgICAgXCIgXFxcbiAgICAgICAgICBidW5kbGUgaW5zdGFsbCAmJiBcXFxuICAgICAgICAgIGJ1bmRsZSBleGVjIHJpZGdlcG9sZSAtLWNvbmZpZyAuL2NvbmZpZy9kYXRhYmFzZS55bWwgLS1maWxlIC4vZGIvc2NoZW1hZmlsZS5yYiAtRSBwcm9kdWN0aW9uIC0tYXBwbHkgJiYgXFxcbiAgICAgICAgICBybSAtZiB0bXAvcGlkcy9zZXJ2ZXIucGlkICYmIFxcXG4gICAgICAgICAgYnVuZGxlIGV4ZWMgcmFpbHMgc2VydmVyIC1lIHByb2R1Y3Rpb24gXFxcbiAgICAgICAgXCJcbiAgICAgIF0sXG4gICAgICB3b3JraW5nRGlyZWN0b3J5OiBcIi9hcHBfcm9vdFwiLFxuICAgICAgZXNzZW50aWFsOiB0cnVlXG4gICAgfSlcblxuICAgIC8vIG5naW54IGNvbnRhaW5lclxuICAgIGNvbnN0IG5naW54Q29udGFpbmVyID0gbmV3IGVjcy5Db250YWluZXJEZWZpbml0aW9uKHRoaXMsIFwibmdpbnhDb250YWluZXJcIiwge1xuICAgICAgY29udGFpbmVyTmFtZTogXCJuZ2lueFwiLFxuICAgICAgdGFza0RlZmluaXRpb24sXG4gICAgICBpbWFnZTogZWNzLkNvbnRhaW5lckltYWdlLmZyb21FY3JSZXBvc2l0b3J5KFxuICAgICAgICBlY3IuUmVwb3NpdG9yeS5mcm9tUmVwb3NpdG9yeU5hbWUodGhpcywgXCJuZ2lueEltYWdlXCIsIGAke3Jlc291Y2VQcmVmaXh9LW5naW54YClcbiAgICAgICksXG4gICAgICBsb2dnaW5nOiBlY3MuTG9nRHJpdmVyLmF3c0xvZ3Moe1xuICAgICAgICBzdHJlYW1QcmVmaXg6IFwicHJvZHVjdGlvblwiLFxuICAgICAgICBsb2dHcm91cFxuICAgICAgfSksXG4gICAgICBwb3J0TWFwcGluZ3M6IFtcbiAgICAgICAge1xuICAgICAgICAgIHByb3RvY29sOiBlY3MuUHJvdG9jb2wuVENQLFxuICAgICAgICAgIGNvbnRhaW5lclBvcnQ6IDgwXG4gICAgICAgIH1cbiAgICAgIF0sXG4gICAgICB3b3JraW5nRGlyZWN0b3J5OiBcIi9hcHBfcm9vdFwiLFxuICAgICAgZXNzZW50aWFsOiB0cnVlXG4gICAgfSlcblxuICAgIC8vIHNoYXJlIHZvbHVtZVxuICAgIG5naW54Q29udGFpbmVyLmFkZFZvbHVtZXNGcm9tKHtcbiAgICAgIHNvdXJjZUNvbnRhaW5lcjogXCJyYWlsc1wiLFxuICAgICAgcmVhZE9ubHk6IGZhbHNlXG4gICAgfSlcblxuICAgIC8vIHNwZWNpZnkgZGVmYXVsdCBjb250YWluZXJcbiAgICB0YXNrRGVmaW5pdGlvbi5kZWZhdWx0Q29udGFpbmVyID0gbmdpbnhDb250YWluZXJcblxuICAgIC8vIFMzIGZvciBsb2dzXG4gICAgY29uc3QgYWxiTG9nc0J1Y2tldCA9IG5ldyBzMy5CdWNrZXQodGhpcywgYGFsYi1sb2dzLWJ1Y2tldC0ke3V1aWQoKX1gKVxuICAgIGNkay5UYWdzLm9mKGFsYkxvZ3NCdWNrZXQpLmFkZChcIk5hbWVcIiwgYCR7cmVzb3VjZVByZWZpeH0tYWxiLWxvZ3MtYnVja2V0YClcblxuICAgIC8vIGxiLCB0YXJnZXQgZ3JvdXAsIHNlcnZpY2VcbiAgICBsZXQgc2VydmljZSA9IG5ldyBlY3NfcGF0dGVybnMuQXBwbGljYXRpb25Mb2FkQmFsYW5jZWRGYXJnYXRlU2VydmljZSh0aGlzLCBcInNlcnZpY2VcIiwge1xuICAgICAgc2VydmljZU5hbWU6IGAke3Jlc291Y2VQcmVmaXh9LXNlcnZpY2VgLFxuICAgICAgY2x1c3RlcixcbiAgICAgIHRhc2tEZWZpbml0aW9uLFxuICAgICAgZGVzaXJlZENvdW50OiAxLFxuICAgICAgbWluSGVhbHRoeVBlcmNlbnQ6IDEwMCxcbiAgICAgIG1heEhlYWx0aHlQZXJjZW50OiAyMDAsXG4gICAgICBhc3NpZ25QdWJsaWNJcDogdHJ1ZSxcbiAgICAgIGhlYWx0aENoZWNrR3JhY2VQZXJpb2Q6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDMwMCksXG4gICAgICBwdWJsaWNMb2FkQmFsYW5jZXI6IHRydWUsXG4gICAgICBzZWN1cml0eUdyb3VwczogW2FsYlNnLCBkYlNnXVxuICAgIH0pXG4gICAgY2RrLlRhZ3Mub2Yoc2VydmljZSkuYWRkKFwiTmFtZVwiLCBgJHtyZXNvdWNlUHJlZml4fS1zZXJ2aWNlYClcbiAgICBzZXJ2aWNlLnRhcmdldEdyb3VwLmhlYWx0aENoZWNrID0ge1xuICAgICAgcGF0aDogXCIvXCIsXG4gICAgICBoZWFsdGh5SHR0cENvZGVzOiBcIjIwMFwiLFxuICAgICAgdW5oZWFsdGh5VGhyZXNob2xkQ291bnQ6IDUsXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKDE1KSxcbiAgICAgIGludGVydmFsOiBEdXJhdGlvbi5zZWNvbmRzKDEyMCksXG4gICAgfVxuXG4gICAgc2VydmljZS5sb2FkQmFsYW5jZXIubG9nQWNjZXNzTG9ncyhhbGJMb2dzQnVja2V0KVxuICB9XG59Il19